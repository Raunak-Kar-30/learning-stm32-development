// USART2 driver program to display the value read and converted using ADC

// Includes
#include <usart.h>

// Function declarations (private)

// Init function - Initialize USART2
void usart2_init(void)
{
	// Enable clock access to USART2 and Port A
	RCC->APB1ENR |= USART2_CLK_EN;
	RCC->AHB1ENR |= GPIOA_CLK_EN;

	// Configure PA2 for USART2 TX (transfer)
	GPIOA->MODER &= ~(1UL << 4);
	GPIOA->MODER |= (1UL << 5);
	GPIOA->AFR[0] |= (1UL << 8 | 1UL << 9 | 1UL << 10);
	GPIOA->AFR[0] &= ~(1UL << 11);

	// Set the over-sampling rate to over sampling by 16. Set the OVER8 bit in CR1 to 0.
	// Set the Word length to 1start bit, 8 data bits
	USART2->CR1 &= ~(USART2_OVER8_EN);
	USART2->CR1 &= ~(1UL << 12);

	// Select the number of stop bits in Control Register 2. We just set the control register 2 to 0.
	USART2->CR2 = 0;

	// Set up the Baud Rate Register such as to get a baud-rate of 9600 with a sys-freq of 16MHz
	USART2->BRR = 0x0683;

	// We want no flow control. We can set control register 3 to 0
	USART2->CR3 = 0;

	// Enable TX in Control register 1
	USART2->CR1 |= USART2_TX_EN;

	// Enable USART2 in CR1
	USART2->CR1 |= USART2_EN;
}

// USART 2 write function - write the value converted by ADC to the computer serial terminal.
// We return the character, since we want it to be read by printf.
void usart2_write(char *data)
{
	// Wait until the data to be transferred, has moved from transfer data register to the shift register, and transfer register is empty.
	while(!(USART2->SR & (USART2_TXE)));

	// Write the data to USART2 Data Register
	USART2->DR = data;

	return data;
}

