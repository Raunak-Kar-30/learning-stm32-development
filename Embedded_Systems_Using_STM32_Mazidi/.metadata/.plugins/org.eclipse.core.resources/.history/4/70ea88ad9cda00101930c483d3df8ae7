// Driver program for blinking an LED using a timer and interrupts instead of polling the Counter (CNT) register

// Includes
#include "timer_interrupt.h"

// Function declarations

// Functions
// Initialize timer 2 and generate an interrupt toggling the LED everytime an interrupt is generated
void blink_led_timer_interrupt()
{
	// Disable all IRQs

	// Enable clock access to the timer
	RCC->APB1ENR |= TIM2_CLK_EN;

	// Set the APB1 prescalar to 16, thus getting a freq of 16MHz/16 = 1MHz
	RCC->CFGR |= (1UL << 10 | 1UL << 11 | 1UL << 12);

	// Set the Auto Reload Register for timer 2. We set ARR to 499999 to get a delay of 500000/1000000 = 0.5 seconds
	TIM2->ARR = 500000 - 1;

	// Enable interrupt for TIM2 by setting the Update Interrupt Enable (UIE) bit of TIM2 DMA/Interrupt Enable register
	// Whenever an interrupt occurs the Update Interrupt Flag (UIF) bit is set in the status register.
	TIM2->DIER |= (1UL << 0);

	// Enable the TIM2
	TIM2->CR1 |= (1UL << 0);

	// Enable TIM2 interrupt in NVIC
	NVIC_EnableIRQ(TIM2_IRQn);

	// Enable all IRQs
	__enable_irq();
}

// ISR for the TIM2 interrupt
// We redefine the TIM2_IRQHandler() in line 177 of 'startup_stm32f446retx.s' file
void TIM2_IRQHandler(void)
{
	// Clear the Update Interrupt Flag bit in the status register
	TIM2->SR &= ~(1UL << 0);

	// Toggle the LED
	GPIOA->ODR ^= (1UL << 5);
}
